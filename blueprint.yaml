# DSL version, should appear in the main blueprint.yaml
# and may appear in other imports. In such case, the versions must match
tosca_definitions_version: cloudify_dsl_1_0

imports:
    - http://www.getcloudify.org/spec/cloudify/3.2m1/types.yaml
    - http://www.getcloudify.org/spec/openstack-plugin/1.2m2/plugin.yaml
    - types/haproxy.yaml

node_templates:

  haproxy_frontend_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: haproxy_frontend_security_group
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_property: [ http_in, port ] }

  haproxy_frontend_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: haproxy_frontend_security_group
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_property: [ http_in, port ] }

  http_in:
    type: haproxy.nodes.Proxy
    properties:
      default_backend: servers
    relationships:
      - target: server1
        type: node_connected_to_backend
        properties:
          backend_address: { get_property: [ server1, ip ] }
          port: { get_property: [ server1,  port ] }
          maxconn: 32
      - target: server2
        type: node_connected_to_backend
        properties:
          backend_address: { get_property: [ server1,  ip ] }
          port: { get_property: [ server1,  port ] }
          maxconn: 32

  server1:
    type: haproxy.nodes.BackEnd
    properties:
      port: { get_property: [ http_in, port ] }


  server2:
    type: haproxy.nodes.BackEnd
    properties:
      port: { get_property: [ http_in, port ] }
