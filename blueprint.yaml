# DSL version, should appear in the main blueprint.yaml
# and may appear in other imports. In such case, the versions must match
tosca_definitions_version: cloudify_dsl_1_0

imports:
  - http://www.getcloudify.org/spec/cloudify/3.2m2/types.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/1.2m2/plugin.yaml
  - types/haproxy.yaml

inputs:

  agent_user:
    default: ''
  agent_public_key_name:
    type: string
  frontend_image_name:
    default: ''
  frontend_flavor_name:
    default: ''
  backend_image_name:
    default: ''
  backend_flavor_name:
    default: ''
  backend_app_port:
    default: 80
  backend_maxconn:
    default: 32

node_templates:

  virtual_ip:
    type: cloudify.openstack.nodes.FloatingIP

  haproxy_frontend_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: haproxy_frontend_security_group
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_property: [ http_in, port ] }

  vm_frontend:
    type: cloudify.openstack.nodes.Server
    properties:
      cloudify_agent:
        user: { get_input: agent_user }
      server:
        image_name: { get_input: frontend_image_name }
        flavor_name: { get_input: frontend_flavor_name }
    relationships:
      - type: cloudify.openstack.server_connected_to_floating_ip
        target: virtual_ip
      - type: cloudify.openstack.server_connected_to_security_group
        target: haproxy_frontend_security_group

  http_in:
    type: haproxy.nodes.Proxy
    properties:
      default_backend: servers
      global_maxconn: 256
      mode: http
      port: 80
      timeout_connect: 5000
      timeout_client: 50000
      timeout_server: 50000
    relationships:
      - target: vm_frontend
        type: cloudify.relationships.contained_in

  haproxy_backend_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: haproxy_backend_security_group
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_input: backend_app_port }

  vm_backend1:
    type: cloudify.openstack.nodes.Server
    properties:
      cloudify_agent:
        user: { get_input: agent_user }
      server:
        image_name: { get_input: backend_image_name }
        flavor_name: { get_input: backend_flavor_name }
    relationships:
      - type: cloudify.openstack.server_connected_to_security_group
        target: haproxy_backend_security_group

  backend1:
    type: haproxy.nodes.BackEnd
    properties:
      port: { get_input: backend_app_port }
      maxconn: { get_input: backend_maxconn }
    relationships:
      - target: vm_backend1
        type: cloudify.relationships.contained_in
      - target: http_in
        type: node_connected_to_frontend
    interfaces:
      cloudify.interfaces.lifecycle:
        configure: hello-world/scripts/configure.sh
        start: hello-world/scripts/start.sh
        stop: hello-world/scripts/stop.sh

  vm_backend2:
    type: cloudify.openstack.nodes.Server
    properties:
      cloudify_agent:
        user: { get_input: agent_user }
      server:
        image_name: { get_input: backend_image_name }
        flavor_name: { get_input: backend_flavor_name }
    relationships:
      - type: cloudify.openstack.server_connected_to_security_group
        target: haproxy_frontend_security_group

  backend2:
    type: haproxy.nodes.BackEnd
    properties:
      port: { get_input: backend_app_port }
      maxconn: { get_input: backend_maxconn }
    relationships:
      - target: vm_backend2
        type: cloudify.relationships.contained_in
      - target: http_in
        type: node_connected_to_frontend
    interfaces:
      cloudify.interfaces.lifecycle:
        configure: hello-world/scripts/configure.sh
        start: hello-world/scripts/start.sh
        stop: hello-world/scripts/stop.sh

